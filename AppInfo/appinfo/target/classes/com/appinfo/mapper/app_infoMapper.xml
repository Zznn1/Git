<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.appinfo.mapper.app_infoMapper" >
  <resultMap id="AppInfo" type="com.appinfo.entity.app_info" >
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="softwareName" property="softwarename" jdbcType="VARCHAR" />
    <result column="APKName" property="apkname" jdbcType="VARCHAR" />
    <result column="supportROM" property="supportrom" jdbcType="VARCHAR" />
    <result column="interfaceLanguage" property="interfacelanguage" jdbcType="VARCHAR" />
    <result column="softwareSize" property="softwaresize" jdbcType="DECIMAL" />
    <result column="updateDate" property="updatedate" jdbcType="DATE" />
    <result column="devId" property="devid" jdbcType="BIGINT" />
    <result column="appInfo" property="appinfo" jdbcType="VARCHAR" />
    <result column="status" property="status" jdbcType="BIGINT" />
    <result column="onSaleDate" property="onsaledate" jdbcType="TIMESTAMP" />
    <result column="offSaleDate" property="offsaledate" jdbcType="TIMESTAMP" />
    <result column="flatformId" property="flatformid" jdbcType="BIGINT" />
    <result column="categoryLevel3" property="categorylevel3" jdbcType="BIGINT" />
    <result column="downloads" property="downloads" jdbcType="BIGINT" />
    <result column="createdBy" property="createdby" jdbcType="BIGINT" />
    <result column="creationDate" property="creationdate" jdbcType="TIMESTAMP" />
    <result column="modifyBy" property="modifyby" jdbcType="BIGINT" />
    <result column="modifyDate" property="modifydate" jdbcType="TIMESTAMP" />
    <result column="categoryLevel1" property="categorylevel1" jdbcType="BIGINT" />
    <result column="categoryLevel2" property="categorylevel2" jdbcType="BIGINT" />
    <result column="logoPicPath" property="logopicpath" jdbcType="VARCHAR" />
    <result column="logoLocPath" property="logolocpath" jdbcType="VARCHAR" />
    <result column="versionId" property="versionid" jdbcType="BIGINT" />
<!--    <association property="dictionary" javaType="com.appinfo.entity.data_dictionary">
    </association>
    <association property="category" javaType="com.appinfo.entity.app_category">
    </association>-->
  </resultMap>

  <select id="getAlls" resultType="com.appinfo.entity.app_info">
    SELECT * ,
    (SELECT valueName FROM data_dictionary d WHERE  a.status=d.valueId AND d.typeCode='APP_STATUS') AS statusName,
    (SELECT valueName FROM data_dictionary d WHERE  a.flatformId=d.valueId AND d.typeCode='APP_FLATFORM') AS flatformName,
    (SELECT categoryName FROM app_category c WHERE  c.id=a.categoryLevel1) AS categoryLevel1Name,
    (SELECT categoryName FROM app_category c WHERE  c.id=a.categoryLevel2) AS categoryLevel2Name,
    (SELECT categoryName FROM app_category c WHERE  c.id=a.categoryLevel3) AS categoryLevel3Name,
    (SELECT v.versionNo FROM app_version v WHERE v.id=a.versionId ) AS versionNo
    FROM app_info AS a WHERE 1=1
    <if test="softwareName!=null and softwareName!=''">
      AND a.softwareName LIKE CONCAT ('%',#{softwareName},'%')
    </if>
    <if test="flatformId>0">
      AND a.flatformId=#{flatformId}
    </if>
    <if test="categoryLevel3>-1 and categoryLevel3!=null">
      AND a.categoryLevel3=#{categoryLevel3}
    </if>
    <if test="categoryLevel2>-1 and categoryLevel2!=null">
      AND a.categoryLevel2=#{categoryLevel2}
    </if>
    <if test="categoryLevel1>-1">
      AND a.categoryLevel1=#{categoryLevel1}
    </if>
    AND a.status=1  order by a.id desc
  </select>


  <select id="getAllList" resultType="com.appinfo.entity.app_info">
    SELECT * ,
    (SELECT valueName FROM data_dictionary d WHERE  a.status=d.valueId AND d.typeCode='APP_STATUS') AS statusName,
    (SELECT valueName FROM data_dictionary d WHERE  a.flatformId=d.valueId AND d.typeCode='APP_FLATFORM') AS flatformName,
    (SELECT categoryName FROM app_category c WHERE  c.id=a.categoryLevel1) AS categoryLevel1Name,
    (SELECT categoryName FROM app_category c WHERE  c.id=a.categoryLevel2) AS categoryLevel2Name,
    (SELECT categoryName FROM app_category c WHERE  c.id=a.categoryLevel3) AS categoryLevel3Name,
    (SELECT v.versionNo FROM app_version v WHERE v.id=a.versionId ) AS versionNo
    FROM app_info AS a WHERE 1=1
    <if test="softwareName!=null and softwareName!=''">
      AND a.softwareName LIKE CONCAT ('%',#{softwareName},'%')
    </if>
    <if test="status>0">
      AND a.status=#{status}
    </if>
    <if test="flatformId>0">
      AND a.flatformId=#{flatformId}
    </if>
    <if test="categoryLevel3>-1 and categoryLevel3!=null">
      AND a.categoryLevel3=#{categoryLevel3}
    </if>
    <if test="categoryLevel2>-1 and categoryLevel2!=null">
      AND a.categoryLevel2=#{categoryLevel2}
    </if>
    <if test="categoryLevel1>-1">
      AND a.categoryLevel1=#{categoryLevel1}
    </if>
  </select>

  <insert id="addApp" parameterType="com.appinfo.entity.app_info">
        INSERT INTO app_info(softwareName,APKName,supportROM,interfaceLanguage,softwareSize,downloads,flatformId,categoryLevel1,categoryLevel2,categoryLevel3,STATUS,appInfo,logoPicPath,logoLocPath,createdBy,creationDate)
            VALUE(#{softwarename},#{apkname},#{supportrom},#{interfacelanguage},#{softwaresize},#{downloads},#{flatformid},#{categorylevel1},#{categorylevel2},#{categorylevel3},#{status},#{appinfo},#{logopicpath},#{logolocpath},#{createdby},#{creationdate})
    </insert>


<select id="getAll" resultType="com.appinfo.entity.app_info">
  select * from app_info
</select>
  <select id="getAppStatus" resultType="com.appinfo.entity.data_dictionary">
    select * from data_dictionary where typeCode="APP_STATUS"
  </select>
  <select id="getFlatFormId" resultType="com.appinfo.entity.data_dictionary">
    select * from data_dictionary where typeCode="APP_FLATFORM"
  </select>
  <select id="getCategoryLevel1" resultType="com.appinfo.entity.app_category">
    select * from app_category where parentId=0;
  </select>
  <select id="getCategoryLevel2" resultType="com.appinfo.entity.app_category">
    select * from app_category  where parentId=#{cid}
    </select>
  <select id="getCategoryLevel3" resultType="com.appinfo.entity.app_category">
    select * from app_category  where parentId=#{cid}
    </select>

  <select id="getOneInfo" resultType="com.appinfo.entity.app_info">
  SELECT * ,
  (SELECT valueName FROM data_dictionary d WHERE  a.status=d.valueId AND d.typeCode='APP_STATUS') AS statusName,
  (SELECT valueName FROM data_dictionary d WHERE  a.flatformId=d.valueId AND d.typeCode='APP_FLATFORM') AS flatformName,
  (SELECT categoryName FROM app_category c WHERE  c.id=a.categoryLevel1) AS categoryLevel1Name,
  (SELECT categoryName FROM app_category c WHERE  c.id=a.categoryLevel2) AS categoryLevel2Name,
  (SELECT categoryName FROM app_category c WHERE  c.id=a.categoryLevel3) AS categoryLevel3Name,
  (SELECT v.versionNo FROM app_version v WHERE v.id=a.versionId ) AS versionNo
  FROM app_info AS a WHERE a.id=#{id}
  </select>

  <update id="updateStatus">
		update app_info set status=#{status} where id = #{id}
	</update>

  <select id="getVersion" resultType="com.appinfo.entity.app_version">
    SELECT * ,
        (SELECT softwareName FROM app_info AS a WHERE a.id=v.appid)AS softwareName,
        (SELECT valueName FROM data_dictionary d WHERE  v.publishStatus=d.valueId AND d.typeCode='APP_STATUS') AS statusName
    FROM app_version AS v WHERE v.appId=#{id}
  </select>

  <update id="updaApp" >
    UPDATE  app_info SET softwarename=#{softwarename} ,apkname=#{apkname},supportrom=#{supportrom},interfacelanguage=#{interfacelanguage},softwaresize=#{softwaresize},downloads=#{downloads},flatformid=#{flatformid},categorylevel1=#{categorylevel1},categorylevel2=#{categorylevel2},categorylevel3=#{categorylevel3},appinfo=#{appinfo} where id=#{id}
  </update>

  <delete id="delectApp">
    delete from app_info where id=#{id}
  </delete>

  <delete id="delAppVersion">
    delete from app_version where appId=#{appId}
  </delete>

  <!--添加App版本-->
  <insert id="addVersion" >
    INSERT INTO app_version(appId,versionNo,versionInfo,publishStatus,downloadLink,versionSize,createdBy,creationDate,apkLocPath,apkFileName)
        VALUE(#{appid},#{versionno},#{versioninfo},#{publishstatus},#{downloadlink},#{versionsize},#{createdby},#{creationdate},#{apklocpath},#{apkfilename})
    </insert>
  <select id="getversion" resultType="com.appinfo.entity.app_version">
    select * from app_version where creationDate=#{creationdate}
  </select>
  <update id="updateVersion">
    update app_info set versionId=#{versionid} where id=#{id}
  </update>

  <select id="getAllVer" resultType="com.appinfo.entity.app_version">
    select * from app_version where id=#{id}
  </select>
  <update id="updateversion" parameterType="com.appinfo.entity.app_version">
    UPDATE app_version
    SET versionNo=#{versionno},versionSize=#{versionsize},versionInfo=#{versioninfo},publishStatus=#{publishstatus},modifyBy=#{modifyby},modifyDate=#{modifydate},apkLocPath=#{apklocpath},apkFileName=#{apkfilename}
    WHERE id=#{id} </update>

  <update id="updateOnUpStatus">
    update app_info set status=#{val} where id=#{id}
  </update>
</mapper>